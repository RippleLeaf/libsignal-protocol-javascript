<script type="text/javascript" src="InMemorySignalProtocolStore.js"></script>
<script type="text/javascript" src="test_setup.js"></script>
<script type="text/javascript" src="../dist/libsignal-protocol.js">

// function initClient(keyId){
//   // var keyId = 6431;
//   var store = new SignalProtocolStore();
//   var KeyHelper = libsignal.KeyHelper;
//   var registrationId = KeyHelper.generateRegistrationId();
//   var identityKeyPair;

//   KeyHelper.generateIdentityKeyPair().then(function(identityKP) { 
//     store.saveIdentity()
//   });
//   var preKey;
//   KeyHelper.generatePreKey(keyId).then(function(preK) {
//     preKey = preK;
//   });
//   var signedPreKey;
//   KeyHelper.generateSignedPreKey(identityKeyPair, keyId).then(function(signedPreK){
//       signedPreKey = signedPreK;
//   });
// }

// var store = new SignalProtocolStore();

Promise.all(
    [initClient("CS.6431", 6431), initClient("May.12", 2018)]).
  then(function(users){
    var alice = users[0];
    var bob = users[1];
    var address = new libsignal.SignalProtocolAddress("May.12", 2018);
    var sessionBuilder = new libsignal.SessionBuilder(alice.store, address);
    var promise = sessionBuilder.processPreKey({
        registrationId: bob.identifier,
        identityKey: bob.store.store.identityKeyMay.pubKey,
        signedPreKey: {
            keyId: bob.keyId,
            publicKey: bob.store.store["25519KeysignedKey2018"].pubKey,
            signature: bob.store.store["25519KeysignedKey2018"].signature,
        },
        preKey:{
            keyId: bob.keyId,
            publicKey: bob.store.store["25519KeypreKey2018"].pubKey,
        }
    });
    console.log(alice);
    console.log(bob);
    // var = ct;

    promise.then(function onsuccess() {
        var plaintext = "Hello world";
        var sessionCipher = new libsignal.SessionCipher(alice.store, address);
        return sessionCipher.encrypt(plaintext);
    }).then(function(ciphertext) {
        // ct = ciphertext;
        // Bob receiving
        console.log(ciphertext);

        var address = new libsignal.SignalProtocolAddress("CS.6431", 6431);
        var sessionCipher = new libsignal.SessionCipher(bob.store, address);
        sessionCipher.decryptPreKeyWhisperMessage(ciphertext.body, "binary").then(function(plaintext) {
          console.log(plaintext);
        }).catch(function(error) {
          console.log(error);
        });
    });
  });


var alice = initClient("CS.6431", 6431)
var bob = initClient("May.12", 2018);

var address = new libsignal.SignalProtocolAddress("May.12",2018);
var sessionBuilder = new libsignal.SessionBuilder(alice.store, address);
var promise = sessionBuilder.processPreKey({
    registrationId: bob.identifier,
    identityKey: bob.store.store.identityKeyMay.pubKey,
    signedPreKey: {
        keyId: bob.keyId,
        publicKey: bob.store.store["25519KeysignedKey2018"].pubKey,
        signature: bob.store.store["25519KeysignedKey2018"].signature,
    },
    preKey:{
        keyId: bob.keyId,
        publicKey: bob.store.store["25519KeypreKey2018"].pubKey,
    }
});

promise.then(function onsuccess() {
    var plaintext = "Hello world";
    var sessionCipher = new libsignal.SessionCipher(alice.store, address);
    return sessionCipher.encrypt(plaintext);
}).then(function(ciphertext) {
    console.log(ciphertext.type);
    console.log(ciphertext.body);
});
</script>
<!-- <script type="text/javascript">
</script> -->
