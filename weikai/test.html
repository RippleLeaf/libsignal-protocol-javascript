<script type="text/javascript" src="InMemorySignalProtocolStore.js"></script>
<script type="text/javascript" src="test_setup.js"></script>
<script type="text/javascript" src="../dist/libsignal-protocol.js">

// function initClient(keyId){
//   // var keyId = 6431;
//   var store = new SignalProtocolStore();
//   var KeyHelper = libsignal.KeyHelper;
//   var registrationId = KeyHelper.generateRegistrationId();
//   var identityKeyPair;

//   KeyHelper.generateIdentityKeyPair().then(function(identityKP) { 
//     store.saveIdentity()
//   });
//   var preKey;
//   KeyHelper.generatePreKey(keyId).then(function(preK) {
//     preKey = preK;
//   });
//   var signedPreKey;
//   KeyHelper.generateSignedPreKey(identityKeyPair, keyId).then(function(signedPreK){
//       signedPreKey = signedPreK;
//   });
// }

// var store = new SignalProtocolStore();

var c = initClient("CS.6431", 6431);
var c2 = initClient("May.12", 2018);
var address = new libsignal.SignalProtocolAddress("May.12",2018);
var sessionBuilder = new libsignal.SessionBuilder(c.store, address);

var promise = sessionBuilder.processPreKey({
    registrationId:c2.identifier,
    identityKey: c2.store.store.identityKeyMay.pubKey,
    signedPreKey: {
        keyId: c2.keyId,
        publicKey: c2.store.store["25519KeysignedKey2018"].pubKey,
        signature: c2.store.store["25519KeysignedKey2018"].signature,
    },
    preKey:{
        keyId: c2.keyId,
        publicKey: c2.store.store["25519KeypreKey2018"].pubKey,
    }
});


promise.then(function onsuccess() {
    var plaintext = "Hello world";
    var sessionCipher = new libsignal.SessionCipher(c.store, address);
    return sessionCipher.encrypt(plaintext);
}).then(function(ciphertext) {
    console.log(ciphertext.type);
    console.log(ciphertext.body);
});
</script>
<!-- <script type="text/javascript">
</script> -->
